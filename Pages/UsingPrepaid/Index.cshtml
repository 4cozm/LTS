@page
@using System.Text.Json
@model LTS.Pages.UsingPrepaid.IndexModel
@{
    ViewData["Title"] = "선불권 사용 인증";
}
<link rel="stylesheet" href="~/css/errorAlert.css" />

<!-- 인증 영역 -->
<div class="container mt-5" style="max-width: 480px;">
    <h2>@ViewData["Title"]</h2>

    @if (TempData["Message"] is string msg)
    {
        <div class="alert alert-info">@msg</div>
    }


    @{
        var codeState = ModelState.ContainsKey("VerificationCode") ? ModelState["VerificationCode"] : null;
        var codeError = codeState?.Errors.FirstOrDefault()?.ErrorMessage;
    }
    @if (!string.IsNullOrEmpty(codeError))
    {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                showNotification(@Html.Raw(JsonSerializer.Serialize(codeError)));
            });
        </script>
    }

    <!-- 전화번호 입력 폼 -->
    <form method="post" asp-page-handler="SendCode">
        <div class="mb-3">
            <label asp-for="PhoneNumber" class="form-label">휴대폰 번호 입력 ("-" 없이)</label>
            <div class="input-group">
                <input asp-for="PhoneNumber" class="form-control" placeholder="-없이 입력하세요" />
                <button type="submit" class="btn btn-primary">검색</button>
            </div>
            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
        </div>
    </form>
</div>

<!-- 결과 테이블 -->
@if (Model.Cards?.Any() == true)
{
    <div class="container mt-5">
        <h2 class="mb-4">해당 고객의 선불권 목록</h2>

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle text-center">
                <thead class="table-dark">
                    <tr>
                        <th>고객명</th>
                        <th>전화번호</th>
                        <th>초기 개수</th>
                        <th>남은 개수</th>
                        <th>만료일</th>
                        <th>사용</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in Model.Cards)
                    {
                        <tr>
                            <td>@c.PurchaserName</td>
                            <td>@c.FormattedPhoneNumber</td>
                            <td>@c.InitialValue</td>
                            <td>@c.RemainingValue</td>
                            <td>@(c.ExpiresAt?.ToString("yyyy-MM-dd") ?? "-")</td>
                            <td>
                                <form method="post" asp-page-handler="UseCard">
                                    <input type="hidden" name="Code" value="@c.Code" />
                                    <button type="button" class="btn btn-sm btn-danger"
                                        onclick="openUseCardModal('@c.Code', '@c.PurchaserName', @c.RemainingValue)">
                                        사용
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@* 사용 수량 입력 모달 *@
<div class="card" id="useCardModal" style="display: none;">
    <div class="card-content">
        <p class="card-heading">선불권 사용</p>
        <p class="card-description"><span id="cardOwner"></span> 고객님의 선불권을 사용합니다.</p>

        <input type="hidden" id="selectedCardCode" />

        <div class="form-group">
            <label for="useAmountInput">사용할 개수</label>
            <input type="number" id="useAmountInput" class="form-control" min="1" value="1" />
            <small id="maxHint" class="text-muted"></small>
        </div>
    </div>

    <div class="card-button-wrapper">
        <button type="button" class="card-button secondary" id="cancelUseCardBtn">취소</button>
        <button type="button" class="card-button primary" id="confirmUseCardBtn">확인</button>
    </div>
</div>

@* 알림 UI *@
<ul class="notification-container" id="notificationBar">
    <li class="notification-item error">
        <div class="notification-content">
            <div class="notification-icon">
                <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="m15 9-6 6m0-6 6 6m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
            </div>
            <div class="notification-text" id="notificationMessage">에러</div>
        </div>
        <div class="notification-icon notification-close">
            <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M6 18 17.94 6M18 18 6.06 6" />
            </svg>
        </div>
        <div class="notification-progress-bar"></div>
    </li>
</ul>

<!-- 스크립트 -->
<script>
    const TIMER_KEY = 'verification_timer_start';
    const timerText = document.getElementById('timerText');
    let timerInterval;

    function showNotification(message) {
        const bar = document.getElementById('notificationBar');
        const text = document.getElementById('notificationMessage');
        bar.addEventListener("click", () => {
            bar.style.display = "none";
        });
        text.textContent = message;
        bar.style.display = 'flex';
        setTimeout(() => {
            bar.style.display = 'none';
        }, 5000);
    }
    @* 에러표시 + 자동숨김 *@
        function showNotification(message) {
            const bar = document.getElementById('notificationBar');
            const text = document.getElementById('notificationMessage');
            bar.addEventListener("click", () => {
                bar.style.display = "none";
            });
            text.textContent = message;
            bar.style.display = 'flex'; // 보이게 함

            // 7초 후 숨김
            setTimeout(() => {
                bar.style.display = 'none';
            }, 5000);
        }

    @* 선불권 사용 모달 띄우기  *@
        function openUseCardModal(code, name, remaining) {
            document.getElementById("selectedCardCode").value = code;
            document.getElementById("cardOwner").textContent = name;
            const input = document.getElementById("useAmountInput");
            input.max = remaining;
            input.value = 1;

            document.getElementById("maxHint").textContent = `(최대 ${remaining}개까지 사용 가능)`;

            document.getElementById("useCardModal").style.display = "block";
        }
</script>
