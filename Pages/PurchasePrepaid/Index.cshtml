@page
@using System.Text.Json
@model LTS.Pages.PurchasePrepaid.IndexModel
@{
    ViewData["Title"] = "ğŸ›’ ì„ ë¶ˆê¶Œ êµ¬ë§¤ ì¸ì¦";
}
<link rel="stylesheet" href="~/css/errorAlert.css" />
<link rel="stylesheet" href="~/css/modal.css" />
<div class="container mt-5" style="max-width: 480px;">
    <h2>@ViewData["Title"]</h2>

    @if (TempData["Message"] is string msg)
    {
        <div class="alert alert-info">@msg</div>
    }

    @*ì¸ì¦ë²ˆí˜¸ ì—ëŸ¬ê°€ ì—¬ëŸ¬ë²ˆ í‹€ë ¤ë„ ì‹œê°ì ìœ¼ë¡œ ë‹¬ë¼ì§€ëŠ”ê²Œ ì—†ì–´ì„œ ì¶”ê°€í•œ ì „ìš© ì•Œë¦¼ì°½*@
    @{
        var codeState = ModelState.ContainsKey("VerificationCode") ? ModelState["VerificationCode"] : null;
        var codeError = codeState?.Errors.FirstOrDefault()?.ErrorMessage;
    }
    @if (!string.IsNullOrEmpty(codeError))
    {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                showNotification(@Html.Raw(JsonSerializer.Serialize(codeError)));
            });
        </script>
    }

    <!-- 1. ì „í™”ë²ˆí˜¸ ì…ë ¥ + ë°œì†¡ ë²„íŠ¼ -->
    @if (!Model.IsCodeSent)
    {
        <form method="post" autocomplete="off" asp-page-handler="SendCode">
            <div class="mb-3">
                <label asp-for="PhoneNumber" class="form-label">íœ´ëŒ€í° ë²ˆí˜¸ ì…ë ¥ ("-" ì—†ì´)</label>
                <div class="input-group">
                    <input asp-for="PhoneNumber" class="form-control" placeholder="-ì—†ì´ ì…ë ¥í•˜ì„¸ìš”" />
                    <button type="submit" class="btn btn-primary h-100 h-100">ì¸ì¦ë²ˆí˜¸ ë°œì†¡</button>
                </div>
                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
            </div>
        </form>
        <script>
            localStorage.removeItem("verification_timer_start"); @*ìƒˆë¡œ ëœë”©í–ˆì„ë•Œ,  ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ íƒ€ì´ë¨¸ë¥¼ ì‚­ì œì²˜ë¦¬ *@
        </script>
    }


    <!-- 2. ì¸ì¦ë²ˆí˜¸ ì…ë ¥ (ë°œì†¡ë˜ì—ˆì„ ë•Œë§Œ ë³´ì—¬ì¤Œ) -->
    @if (Model.IsCodeSent)
    {
        <form method="post" autocomplete="off" asp-page-handler="Verify">
            <div class="mb-3">
                <label asp-for="VerificationCode" class="form-label">ì¸ì¦ë²ˆí˜¸ ì…ë ¥</label>
                <div class="input-group">
                    <input asp-for="VerificationCode" id="verification-code-input" class="form-control" maxlength="6"
                        placeholder="6ìë¦¬ ìˆ«ì" id="verificationInput" />
                    <span id="timerText" class="input-group-text">3ë¶„ ì´ë‚´</span>
                </div>
                <span asp-validation-for="VerificationCode" class="d-none"></span>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" name="action" id="submitBtn" value="verify" class="btn btn-success">í™•ì¸</button>
                <button type="submit" id="resetBtn" name="action" value="reset" class="btn btn-secondary">ì´ˆê¸°í™”</button>
            </div>
        </form>
    }

    @*ì¸ì¦ë²ˆí˜¸ ë¶ˆì¼ì¹˜ ì „ìš© ëª¨ë‹¬ì°½*@
    <ul class="notification-container" id="notificationBar">
        <li class="notification-item error">
            <div class="notification-content">
                <div class="notification-icon">
                    <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="m15 9-6 6m0-6 6 6m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path>
                    </svg>
                </div>
                <div class="notification-text" id="notificationMessage">ì—ëŸ¬</div>
            </div>
            <div class="notification-icon notification-close">
                <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M6 18 17.94 6M18 18 6.06 6"></path>
                </svg>
            </div>
            <div class="notification-progress-bar"></div>
        </li>
    </ul>


</div>


<script>
    @*ì¸ì¦ì°½ íƒ€ì´ë¨¸ ê´€ë ¨*@
    const DURATION = 180; // 3ë¶„
    const TIMER_KEY = 'verification_timer_start';
    const timerText = document.getElementById('timerText');
    let timerInterval;

    function getRemainingTime() {
        const startedAt = localStorage.getItem(TIMER_KEY);
        if (!startedAt) return DURATION;
        const elapsed = Math.floor((Date.now() - parseInt(startedAt)) / 1000);
        return Math.max(0, DURATION - elapsed);
    }

    function setInitialTimerText() {
        const remaining = getRemainingTime();
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} ë‚¨ìŒ`;
    }

    function startTimer() {
        let secondsRemaining = getRemainingTime();

        timerInterval = setInterval(() => {
            const minutes = Math.floor(secondsRemaining / 60);
            const seconds = secondsRemaining % 60;
            timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} ë‚¨ìŒ`;

            if (secondsRemaining <= 0) {
                clearInterval(timerInterval);
                localStorage.removeItem(TIMER_KEY);
                timerText.textContent = 'ë§Œë£Œë¨';
                document.querySelector("#verification-code-input").disabled = true;
                document.querySelector("#submitBtn").disabled = true;
                alert("ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ˆê¸°í™” ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ ì£¼ì„¸ìš”");
            } else {
                secondsRemaining--;
            }
        }, 1000);
    }

    resetBtn?.addEventListener('click', function () {
        localStorage.removeItem(TIMER_KEY);
        clearInterval(timerInterval);
    });

    if (!localStorage.getItem(TIMER_KEY)) {
        localStorage.setItem(TIMER_KEY, Date.now().toString());
    }
    setInitialTimerText();
    startTimer();

    @* ì—ëŸ¬í‘œì‹œ + ìë™ìˆ¨ê¹€ *@
        function showNotification(message) {
            const bar = document.getElementById('notificationBar');
            const text = document.getElementById('notificationMessage');
            bar.addEventListener("click", () => {
                bar.style.display = "none";
            });
            text.textContent = message;
            bar.style.display = 'flex'; // ë³´ì´ê²Œ í•¨

            // 7ì´ˆ í›„ ìˆ¨ê¹€
            setTimeout(() => {
                bar.style.display = 'none';
            }, 5000);
        }
</script>
